---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: jobs-role-cluster
rules:
# Framework: runtime observation of namespaces & CRDs (addition/deletion).
- apiGroups: [apiextensions.k8s.io]
  resources: [customresourcedefinitions]
  verbs: [list, watch]
- apiGroups: ['']
  resources: [namespaces, pods]
  verbs: [list, watch]
# Framework: admission webhook configuration management.
- apiGroups: [admissionregistration.k8s.io/v1, admissionregistration.k8s.io/v1beta1]
  resources: [validatingwebhookconfigurations, mutatingwebhookconfigurations]
  verbs: [create, patch]
# Application: read-only access for watching cluster-wide.
- apiGroups: [squonk.it]
  resources: [datamanagerjobs]
  verbs: [list, watch]

---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: {{ jo_dmapi_namespace }}
  name: jobs-role-namespaced
rules:
# Framework: posting the events about the handlers progress/errors.
- apiGroups: ['']
  resources: [events]
  verbs: [create]
# Application: watching & handling for the custom resource we declare.
- apiGroups: [squonk.it]
  resources: [datamanagerjobs]
  verbs: [list, watch, patch]
# Application: other resources it produces and manipulates.
# Here, we create Jobs+PVCs+Pods, but we do not patch/update/delete them ever.
- apiGroups: [batch, extensions]
  resources: [jobs]
  verbs: [create]
- apiGroups: [apps, extensions, '']
  resources: [pods, configmaps]
  verbs: [get, list, watch, create, delete]

---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: jobs-rolebinding-cluster-{{ jo_dmapi_name }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: jobs-role-cluster
subjects:
- kind: ServiceAccount
  name: jobs-account
  namespace: {{ jo_dmapi_namespace }}

---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: {{ jo_dmapi_namespace }}
  name: jobs-rolebinding-namespaced
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: jobs-role-namespaced
subjects:
- kind: ServiceAccount
  name: jobs-account
